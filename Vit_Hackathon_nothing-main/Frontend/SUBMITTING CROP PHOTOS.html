<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLN Data Collection</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body style="font-family: var(--font-primary); text-align: center; margin: var(--spacing-lg); background-image: url('https://img.freepik.com/premium-photo/new-plants-sprouting-field-dirt-showcase-beauty-potential-new-plant-growth-agriculture-farming-emphasizing-sustainable_38013-11280.jpg'); background-size: cover; background-position: center; color: var(--white);">

    <header class="header">
        <div class="container">
            <h1>DIGITAL INDIA FARMING AND MONITORING SYSTEM</h1>
        </div>
    </header>

    <div style="background-color: rgba(0, 0, 255, 0.7); padding: var(--spacing-md); margin: var(--spacing-lg) 0; border-radius: var(--border-radius-md);">
        <marquee direction="left" scrollamount="3" style="font-size: var(--font-size-lg); color: var(--white); font-weight: bold;">***" రైతుల పంట వివరములు తెలుసుకొనుటకు మరియు ప్రభుత్వ పధకములు అర్హత గల రైతులకు చేరుటకు "***</marquee>
    </div>

    <div class="container">
        <div class="form-container">
            <h2>FLN Data Collection Form</h2>

            <div class="form-group">
                <label class="form-label">FLN Number:</label>
                <input type="text" id="flnNumber" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Date & Time (Auto-filled):</label>
                <input type="text" id="dateTimeInput" class="form-input" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">GPS Location (Latitude, Longitude):</label>
                <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                    <input type="text" id="gpsLocation" class="form-input" readonly>
                    <button class="btn" onclick="getLocation()">Get GPS</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Upload up to 8 Land Photos:</label>
                <input type="file" id="photoInput" class="form-input" accept="image/*" multiple>
            </div>

            <button class="btn btn-secondary" onclick="submitData()">Submit</button>

            <p id="response" style="color: var(--success-color); font-weight: bold; margin-top: var(--spacing-lg);"></p>
        </div>
    </div>

    <script>
        function getCurrentDateTime() {
            let today = new Date();
            let day = today.getDate().toString().padStart(2, '0');
            let month = (today.getMonth() + 1).toString().padStart(2, '0');
            let year = today.getFullYear();
            let hours = today.getHours().toString().padStart(2, '0');
            let minutes = today.getMinutes().toString().padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }
        document.getElementById("dateTimeInput").value = getCurrentDateTime();

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    let lat = position.coords.latitude.toFixed(6);
                    let lon = position.coords.longitude.toFixed(6);
                    document.getElementById("gpsLocation").value = `${lat}, ${lon}`;
                }, function (error) {
                    alert("Error fetching location: " + error.message);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function submitData() {
            var flnNumber = document.getElementById("flnNumber").value;
            var dateTimeInput = document.getElementById("dateTimeInput").value;
            var gpsLocation = document.getElementById("gpsLocation").value;
            var photoInput = document.getElementById("photoInput").files;

            if (!flnNumber || !gpsLocation || photoInput.length === 0) {
                alert("Please enter the FLN number, get GPS location, and select at least one image!");
                return;
            }

            if (photoInput.length > 8) {
                alert("You can only upload up to 8 photos.");
                return;
            }

            var imagesData = [];
            var loadedCount = 0;

            for (let i = 0; i < photoInput.length; i++) {
                let reader = new FileReader();
                reader.onloadend = function () {
                    imagesData.push({
                        name: photoInput[i].name,
                        type: photoInput[i].type,
                        data: reader.result.split(",")[1]
                    });

                    loadedCount++;
                    if (loadedCount === photoInput.length) {
                        google.script.run.withSuccessHandler(function (response) {
                            document.getElementById("response").innerText = response;
                            document.getElementById("flnNumber").value = "";
                            document.getElementById("photoInput").value = "";
                            document.getElementById("gpsLocation").value = "";
                            document.getElementById("dateTimeInput").value = getCurrentDateTime();
                        }).saveData({ flnNumber: flnNumber, gpsLocation: gpsLocation, images: imagesData });
                    }
                };
                reader.readAsDataURL(photoInput[i]);
            }
        }
    </script>

</body>

</html>